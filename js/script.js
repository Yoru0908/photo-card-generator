

const translations = {
    en: {
        mainTitle: "Sakamichi Photo Card Generator",
        siteDescription: "Free online generator for Sakamichi Series Trading cards<br>(Sakurazaka46, Nogizaka46, Hinatazaka46)<br>Easily customize to create and download your photo cards with one click.",
        customContentTitle: "Customize Content",
        uploadMainImageLabel: "1. Upload Main Image",
        memberNameLabel: "3. Member Name",
        memberNamePlaceholder: "Enter member's name",
        romajiNameLabel: "4. Romaji (Optional)",
        romajiNamePlaceholder: "Enter Romaji",
        photoThemeLabelLine1: "5. Theme",
        photoThemeLabelLine2: "5b. Theme (Line 2, Optional)",
        photoThemePlaceholder: "Enter theme",
        groupNameLabel: "2. Group Name",
        colorsAndBordersLabel: "7. Colors & Borders",
        infoBarBgColorLabel: "Info Bar BG Color",
        textColorLabel: "Text/Logo Color",
        infoBarBorderLabel: "Info Bar Border",
        thicknessLabel: "Thickness: {value}px",
        sizePositionTuningLabel: "8. Size & Position Tuning",
        customLogoLabel: "Custom Logo",
        resetInfoBarLabel: "Reset All Parameters",
        resetButton: "Reset",
        infoBarPositionLabel: "Info Bar Position",
        marginBottomLabel: "Bottom Margin: {value}px",
        marginXLabel: "Side Margin: {value}px",
        fontAndSizeTuningLabel: "Font & Size Tuning",
        infoBarPositionAndSizeLabel: "・Info Bar Size",
        sizeAdjustmentLabel: "・Element Size Tuning",
        fontStyleLabel: "6. Font Style",
        resetInfoBarButton: "Reset All Parameters",
        showRomajiLabel: "Show Romaji",
        showThemeLine2Label: "Show Theme Line 2",
        infoBarPaddingYLabel: "Info Bar Padding: {value}px",
        logoSizeLabel: "Logo Size: {value}px",
        groupNameSizeLabel: "Group Name Size: {value}px",
        themeSizeLabel: "Theme Size: {value}px",
        themeLine2SizeLabel: "Theme L2 Size: {value}px",
        memberNameSizeLabel: "Name Size: {value}px",
        romajiNameSizeLabel: "Romaji Size: {value}px",
        elementPositionTuningLabel: "・Element Position Tuning",
        logoPositionLabel: "Logo Position",
        horizontalPositionLabel: "Horizontal (X): {value}px",
        verticalPositionLabel: "Vertical (Y): {value}px",
        groupNamePositionLabel: "Group Name Position",
        themePositionLabel: "Theme Position",
        themeLine2PositionLabel: "Theme (Line 2) Position",
        namePositionLabel: "Name Position",
        romajiPositionLabel: "Romaji Position",
        fontStyleTuningLabel: "Font Style Tuning",
        themeFontLabel: "Theme",
        defaultFont: "UDXinWan (Default)",
        yujiFont: "Yuji Syuku Style (Yuji)",
        serifFont: "System Serif",
        sansSerifFont: "System Sans-Serif",
        nameFontLabel: "Name/Romaji",
        uploadCustomFontLabel: "Upload Custom Font",
        themeWeightLabel: "Theme Weight:",
        nameWeightLabel: "Name Weight:",
        romajiWeightLabel: "Romaji Weight:",
        themeLetterSpacingLabel: "Theme Spacing: {value}px",
        nameLetterSpacingLabel: "Name Spacing: {value}px",
        romajiLetterSpacingLabel: "Romaji Spacing: {value}px",
        generateButton: "Generate & Download Image",
        loadingText: "Generating image, please wait...",
        authorAndFeedbackLabel: "Author & Feedback",
        authorName: "Author: Yoru",
        altAccount: "Alt Account: Yoru0908",
        qqGroup: "QQ Group: 478628703",
        feedbackLabel: "Feedback (Bugs/Suggestions)",
        feedbackButton: "Click here to submit feedback",
        cancelButton: "Cancel",
        cropButton: "Crop",
        errorTitle: "An Error Occurred",
        errorMessage: "Image generation failed. Please try again later.",
        closeButton: "Close",
        fontLoading: "Loading font \"{fontName}\"",
        fontLoaded: "Font \"{fontName}\" loaded successfully!",
        fontError: "Font loading failed. Please check the file format.",
        customFontSuffix: " (Custom)",
        longPressInstruction: "Long-press the image to save",
        uploadImagePlaceholder: "Please upload an image",
        uploadImageHint: "Supports JPG, PNG formats",
        createdBy: "Created by",
        currentYear: "2025",
        footerDescription: "Photo Template Generator - Made for Sakamichi Idol Fans"
    },
    ja: {
        mainTitle: "坂道シリーズ 生写真ジェネレーター",
        siteDescription: "無料の坂道シリーズ生写真オンラインジェネレーター<br>（櫻坂46、乃木坂46、日向坂46）<br>簡単にカスタマイズし、ワンクリックであなたの生写真を自作・ダウンロードできます。",
        customContentTitle: "コンテンツのカスタマイズ",
        uploadMainImageLabel: "1. メイン画像のアップロード",
        memberNameLabel: "3. メンバー名",
        memberNamePlaceholder: "メンバー名を入力",
        romajiNameLabel: "4. ローマ字 (任意)",
        romajiNamePlaceholder: "ローマ字を入力",
        photoThemeLabelLine1: "5. テーマ",
        photoThemeLabelLine2: "5b. テーマ（2行目、任意）",
        photoThemePlaceholder: "テーマを入力",
        groupNameLabel: "2. グループ名",
        colorsAndBordersLabel: "7. 色と枠線",
        infoBarBgColorLabel: "情報バーの背景色",
        textColorLabel: "文字/ロゴの色",
        infoBarBorderLabel: "情報バーの枠線",
        thicknessLabel: "太さ: {value}px",
        sizePositionTuningLabel: "8. サイズと位置の調整",
        customLogoLabel: "カスタムロゴ",
        resetInfoBarLabel: "すべてのパラメータをリセット",
        resetButton: "リセット",
        infoBarPositionLabel: "情報バーの位置",
        marginBottomLabel: "下マージン: {value}px",
        marginXLabel: "左右マージン: {value}px",
        fontAndSizeTuningLabel: "フォントとサイズの調整",
        infoBarPositionAndSizeLabel: "・情報バーのサイズ",
        sizeAdjustmentLabel: "・要素サイズ調整",
        fontStyleLabel: "6. フォントスタイル",
        resetInfoBarButton: "すべてのパラメータをリセット",
        showRomajiLabel: "ローマ字を表示",
        showThemeLine2Label: "テーマの2行目を表示",
        infoBarPaddingYLabel: "情報バーのパディング: {value}px",
        logoSizeLabel: "ロゴサイズ: {value}px",
        groupNameSizeLabel: "グループ名サイズ: {value}px",
        themeSizeLabel: "テーマサイズ: {value}px",
        themeLine2SizeLabel: "テーマ2行目サイズ: {value}px",
        memberNameSizeLabel: "名前サイズ: {value}px",
        romajiNameSizeLabel: "ローマ字サイズ: {value}px",
        elementPositionTuningLabel: "・要素位置の微調整",
        logoPositionLabel: "ロゴの位置",
        horizontalPositionLabel: "水平位置 (X): {value}px",
        verticalPositionLabel: "垂直位置 (Y): {value}px",
        groupNamePositionLabel: "グループ名の位置",
        themePositionLabel: "テーマの位置",
        themeLine2PositionLabel: "テーマ（2行目）の位置",
        namePositionLabel: "名前の位置",
        romajiPositionLabel: "ローマ字の位置",
        fontStyleTuningLabel: "フォントスタイルの微調整",
        themeFontLabel: "テーマ",
        defaultFont: "UDXinWan (デフォルト)",
        yujiFont: "游秀体 (Yuji)",
        serifFont: "システム セリフ",
        sansSerifFont: "システム サンセリフ",
        nameFontLabel: "名前/ローマ字",
        uploadCustomFontLabel: "カスタムフォントをアップロード",
        themeWeightLabel: "テーマの太さ:",
        nameWeightLabel: "名前の太さ:",
        romajiWeightLabel: "ローマ字の太さ:",
        themeLetterSpacingLabel: "テーマの字間: {value}px",
        nameLetterSpacingLabel: "名前の字間: {value}px",
        romajiLetterSpacingLabel: "ローマ字の字間: {value}px",
        generateButton: "画像を生成してダウンロード",
        loadingText: "画像を生成しています、しばらくお待ちください...",
        authorAndFeedbackLabel: "作者情報とフィードバック",
        authorName: "作者: Yoru",
        altAccount: "Bilibiliサブ垢: Yoru0908",
        qqGroup: "QQグループ: 478628703",
        feedbackLabel: "フィードバック (バグ/提案)",
        feedbackButton: "こちらをクリックしてフィードバックを送信",
        cancelButton: "キャンセル",
        cropButton: "切り抜き",
        errorTitle: "エラーが発生しました",
        errorMessage: "画像の生成に失敗しました。後でもう一度お試しください。",
        closeButton: "閉じる",
        fontLoading: "フォント\"{fontName}\"を読み込み中...",
        fontLoaded: "フォント\"{fontName}\"の読み込みに成功しました！",
        fontError: "フォントの読み込みに失敗しました。ファイル形式を確認してください。",
        customFontSuffix: " (カスタム)",
        longPressInstruction: "画像を長押しして保存してください",
        uploadImagePlaceholder: "画像をアップロードしてください",
        uploadImageHint: "JPG、PNG形式に対応",
        createdBy: "作成者",
        currentYear: "2025",
        footerDescription: "生写真テンプレートジェネレーター - 坂道系アイドルファンのために"
    },
    zh: {
        mainTitle: "坂道系生写生成器",
        siteDescription: "免费的坂道系（樱坂46、乃木坂46、日向坂46）偶像生写在线生成器。<br>轻松自定义成员名、主题、字体和颜色，一键制作并下载专属风格的生写照片。",
        customContentTitle: "自定义内容",
        uploadMainImageLabel: "1. 上传主图片",
        memberNameLabel: "3. 成员姓名",
        memberNamePlaceholder: "请输入成员姓名",
        romajiNameLabel: "4. 罗马字 (可选)",
        romajiNamePlaceholder: "请输入罗马字",
        photoThemeLabelLine1: "5. 主题",
        photoThemeLabelLine2: "5b. 主题 (第二行, 可选)",
        photoThemePlaceholder: "请输入主题",
        groupNameLabel: "2. 团体名字",
        colorsAndBordersLabel: "7. 颜色与边框",
        infoBarBgColorLabel: "信息栏底色",
        textColorLabel: "文字/Logo颜色",
        infoBarBorderLabel: "信息栏边框",
        thicknessLabel: "粗细: {value}px",
        sizePositionTuningLabel: "8. 尺寸位置微调",
        customLogoLabel: "自定义Logo",
        resetInfoBarLabel: "重置所有参数",
        resetButton: "重置",
        infoBarPositionLabel: "信息栏位置",
        marginBottomLabel: "下边距: {value}px",
        marginXLabel: "左右边距: {value}px",
        fontAndSizeTuningLabel: "字体与尺寸微调",
        infoBarPositionAndSizeLabel: "・信息栏尺寸",
        sizeAdjustmentLabel: "・元素尺寸微调",
        fontStyleLabel: "6. 字体样式",
        resetInfoBarButton: "重置所有参数",
        showRomajiLabel: "显示罗马字",
        showThemeLine2Label: "显示主题第二行",
        infoBarPaddingYLabel: "信息栏内边距: {value}px",
        logoSizeLabel: "Logo大小: {value}px",
        groupNameSizeLabel: "团名大小: {value}px",
        themeSizeLabel: "主题大小: {value}px",
        themeLine2SizeLabel: "主题二行大小: {value}px",
        memberNameSizeLabel: "姓名大小: {value}px",
        romajiNameSizeLabel: "罗马字大小: {value}px",
        elementPositionTuningLabel: "・元素位置微调",
        logoPositionLabel: "Logo 位置",
        horizontalPositionLabel: "水平位置 (X): {value}px",
        verticalPositionLabel: "垂直位置 (Y): {value}px",
        groupNamePositionLabel: "团名位置",
        themePositionLabel: "主题 (第一行) 位置",
        themeLine2PositionLabel: "主题 (第二行) 位置",
        namePositionLabel: "姓名位置",
        romajiPositionLabel: "罗马字位置",
        fontStyleTuningLabel: "字体样式微调",
        themeFontLabel: "主题",
        defaultFont: "UDXinWan (默认)",
        yujiFont: "日式秀气体 (Yuji)",
        serifFont: "系统衬线体",
        sansSerifFont: "系统无衬线体",
        nameFontLabel: "姓名/罗马字",
        uploadCustomFontLabel: "上传自定义字体",
        themeWeightLabel: "主题粗细:",
        nameWeightLabel: "姓名粗细:",
        romajiWeightLabel: "罗马字粗细:",
        themeLetterSpacingLabel: "主题字间距: {value}px",
        nameLetterSpacingLabel: "姓名字间距: {value}px",
        romajiLetterSpacingLabel: "罗马字字间距: {value}px",
        generateButton: "生成并下载图片",
        loadingText: "正在生成图片，请稍候...",
        authorAndFeedbackLabel: "作者信息 & 反馈",
        authorName: "作者: Yoru",
        altAccount: "稍转樱的小号: Yoru0908",
        qqGroup: "没有人的Q群: 478628703",
        feedbackLabel: "问题反馈 (Bugs/建议)",
        feedbackButton: "点击此处提交反馈",
        cancelButton: "取消",
        cropButton: "裁切",
        errorTitle: "发生错误",
        errorMessage: "图片生成失败，请稍后再试。",
        closeButton: "关闭",
        fontLoading: "正在加载字体 \"{fontName}\"...",
        fontLoaded: "字体 \"{fontName}\" 加载成功!",
        fontError: "字体加载失败，请检查文件格式。",
        customFontSuffix: " (自定义)",
        longPressInstruction: "请长按图片保存",
        uploadImagePlaceholder: "请上传图片",
        uploadImageHint: "支持 JPG、PNG 格式",
        createdBy: "Created by",
        currentYear: "2025",
        footerDescription: "为坂道系偶像粉丝打造的生写制作工具"
    }
};

document.addEventListener('DOMContentLoaded', function () {
    // --- I18n Functions ---
    let currentLang = 'zh';

    const setLanguage = (lang) => {
        currentLang = lang;
        document.documentElement.lang = lang;

        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang] && translations[lang][key]) {
                el.innerHTML = translations[lang][key];
            }
        });

        // Explicitly update site description to fix translation bug.
        const siteDescriptionEl = document.getElementById('site-description');
        if (siteDescriptionEl && translations[lang] && translations[lang].siteDescription) {
            siteDescriptionEl.innerHTML = translations[lang].siteDescription;
        }

        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            if (translations[lang] && translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });

        // 控制底部描述文本和站点链接的显示/隐藏
        const footerDescription = document.getElementById('footer-description');
        const siteLinks = document.getElementById('site-links');

        if (footerDescription) {
            if (lang === 'zh') {
                footerDescription.style.display = 'none';
            } else {
                footerDescription.style.display = 'block';
            }
        }


        updateAllDynamicLabels();
    };

    const updateAllDynamicLabels = () => {
        document.querySelectorAll('[data-translate-template]').forEach(label => {
            const key = label.getAttribute('data-translate-template');
            const valueSpan = label.querySelector('span');
            if (valueSpan && translations[currentLang] && translations[currentLang][key]) {
                const template = translations[currentLang][key];
                const value = valueSpan.textContent;
                const parts = template.split('{value}');
                label.innerHTML = '';
                label.appendChild(document.createTextNode(parts[0]));
                label.appendChild(valueSpan);
                label.appendChild(document.createTextNode(parts[1]));
            }
        });
    };

    // --- Element Cache ---
    const ui = {
        languageSwitcher: document.getElementById('language-switcher'),
        mainTitle: document.getElementById('main-title'),
        controlPanel: document.getElementById('control-panel'),
        body: document.body,
        imageUpload: document.getElementById('image-upload'),
        logoUpload: document.getElementById('logo-upload'),
        memberName: document.getElementById('member-name'),
        romajiName: document.getElementById('romaji-name'),
        photoTheme: document.getElementById('photo-theme'),
        photoThemeLine2: document.getElementById('photo-theme-line-2'),
        groupNameSelect: document.getElementById('group-name-select'),
        downloadBtn: document.getElementById('download-btn'),
        loadingText: document.getElementById('loading-text'),
        previewImage: document.getElementById('preview-image'),
        placeholderContent: document.getElementById('placeholder-content'),
        imageContainer: document.getElementById('image-container'),
        svgLogo: document.getElementById('svg-logo'),
        imageLogo: document.getElementById('image-logo'),
        logoContainer: document.getElementById('logo-container'),
        groupNameImage: document.getElementById('group-name-image'),
        previewName: document.getElementById('preview-name'),
        previewRomaji: document.getElementById('preview-romaji'),
        previewTheme: document.getElementById('preview-theme'),
        previewThemeLine2: document.getElementById('preview-theme-line-2'),
        photoCard: document.getElementById('photo-card'),
        infoBar: document.getElementById('info-bar'),
        infoBarContainer: document.getElementById('info-bar-container'),
        borderToggle: document.getElementById('border-toggle'),
        borderColor: document.getElementById('border-color'),
        infoColor: document.getElementById('info-color'),
        infoBarBgColor: document.getElementById('info-bar-bg-color'),
        marginBottom: document.getElementById('margin-bottom'),
        marginX: document.getElementById('margin-x'),
        marginBottomValue: document.getElementById('margin-bottom-value'),
        marginXValue: document.getElementById('margin-x-value'),
        resetInfoBarBtn: document.getElementById('reset-info-bar-btn'),
        borderThickness: document.getElementById('border-thickness'),
        borderThicknessValue: document.getElementById('border-thickness-value'),
        infoBarPaddingY: document.getElementById('info-bar-padding-y'),
        infoBarPaddingYValue: document.getElementById('info-bar-padding-y-value'),
        logoSize: document.getElementById('logo-size'),
        logoSizeValue: document.getElementById('logo-size-value'),
        groupNameSize: document.getElementById('group-name-size'),
        groupNameSizeValue: document.getElementById('group-name-size-value'),
        themeSize: document.getElementById('theme-size'),
        themeSizeValue: document.getElementById('theme-size-value'),
        themeLine2Size: document.getElementById('theme-line-2-size'),
        themeLine2SizeValue: document.getElementById('theme-line-2-size-value'),
        memberNameSize: document.getElementById('member-name-size'),
        memberNameSizeValue: document.getElementById('member-name-size-value'),
        romajiNameSize: document.getElementById('romaji-name-size'),
        romajiNameSizeValue: document.getElementById('romaji-name-size-value'),
        logoBlock: document.getElementById('logo-block'),
        logoX: document.getElementById('logo-x'),
        logoXValue: document.getElementById('logo-x-value'),
        logoY: document.getElementById('logo-y'),
        logoYValue: document.getElementById('logo-y-value'),
        groupNameBlock: document.getElementById('group-name-block'),
        groupNameX: document.getElementById('group-name-x'),
        groupNameXValue: document.getElementById('group-name-x-value'),
        groupNameY: document.getElementById('group-name-y'),
        groupNameYValue: document.getElementById('group-name-y-value'),
        themeBlock: document.getElementById('theme-block'),
        themeX: document.getElementById('theme-x'),
        themeXValue: document.getElementById('theme-x-value'),
        themeY: document.getElementById('theme-y'),
        themeYValue: document.getElementById('theme-y-value'),
        themeLine2Block: document.getElementById('theme-line-2-block'),
        themeLine2X: document.getElementById('theme-line-2-x'),
        themeLine2XValue: document.getElementById('theme-line-2-x-value'),
        themeLine2Y: document.getElementById('theme-line-2-y'),
        themeLine2YValue: document.getElementById('theme-line-2-y-value'),
        nameBlock: document.getElementById('name-block'),
        nameX: document.getElementById('name-x'),
        nameXValue: document.getElementById('name-x-value'),
        nameY: document.getElementById('name-y'),
        nameYValue: document.getElementById('name-y-value'),
        romajiBlock: document.getElementById('romaji-block'),
        romajiX: document.getElementById('romaji-x'),
        romajiXValue: document.getElementById('romaji-x-value'),
        romajiY: document.getElementById('romaji-y'),
        romajiYValue: document.getElementById('romaji-y-value'),
        themeFontFamily: document.getElementById('theme-font-family'),
        nameFontFamily: document.getElementById('name-font-family'),
        themeLetterSpacing: document.getElementById('theme-letter-spacing'),
        themeLetterSpacingValue: document.getElementById('theme-letter-spacing-value'),
        memberNameLetterSpacing: document.getElementById('member-name-letter-spacing'),
        memberNameLetterSpacingValue: document.getElementById('member-name-letter-spacing-value'),
        romajiNameLetterSpacing: document.getElementById('romaji-name-letter-spacing'),
        romajiNameLetterSpacingValue: document.getElementById('romaji-name-letter-spacing-value'),
        romajiToggle: document.getElementById('romaji-toggle'),
        themeLine2Toggle: document.getElementById('theme-line-2-toggle'),
        fontUpload: document.getElementById('font-upload'),
        fontUploadStatus: document.getElementById('font-upload-status'),
        errorModal: document.getElementById('error-modal'),
        errorMessage: document.getElementById('error-message'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        cropModal: document.getElementById('crop-modal'),
        imageToCrop: document.getElementById('image-to-crop'),
        cropBtn: document.getElementById('crop-btn'),
        cancelCropBtn: document.getElementById('cancel-crop-btn'),
        saveModal: document.getElementById('save-modal'),
        finalImage: document.getElementById('final-image'),
        closeSaveModalBtn: document.getElementById('close-save-modal-btn'),
    };

    const colorPresets = {
        '櫻坂46': { bg: '#FFFFFF', text: '#F19DB5', border: '#F19DB5', bodyBg: '#f0f2f5', titleColor: '#F19DB5' },
        '乃木坂46': { bg: '#742581', text: '#FFFFFF', border: '#742581', bodyBg: '#f0f2f5', titleColor: '#742581' },
        '日向坂46': { bg: '#7cc7e8', text: '#FFFFFF', border: '#7cc7e8', bodyBg: '#7cc7e8', titleColor: '#FFFFFF' }
    };

    const groupLogos = {
        '櫻坂46': 'images/樱坂46logo.png',
        '日向坂46': 'images/日向坂46logo.png',
        '乃木坂46': 'images/乃木坂46logo.png'
    };

    const groupNameImages = {
        '櫻坂46': 'images/樱坂46文字.png',
        '日向坂46': 'images/日向坂46文字.png',
        '乃木坂46': 'images/乃木坂46文字.png'
    };

    let imageState = { scale: 1, translateX: 0, translateY: 0 };
    let isDragging = false;
    let startX, startY;
    let cropper = null;

    // --- Update Functions ---
    const update = {
        infoBarBorder() {
            const isEnabled = ui.borderToggle.checked;
            ui.borderColor.disabled = !isEnabled;
            ui.borderThickness.disabled = !isEnabled;
            if (isEnabled) {
                const thickness = ui.borderThickness.value;
                ui.infoBar.style.border = `${thickness}px solid ${ui.borderColor.value}`;
                ui.borderThicknessValue.textContent = thickness;
            } else {
                ui.infoBar.style.border = 'none';
            }
            updateAllDynamicLabels();
        },
        infoColor() {
            const newColor = ui.infoColor.value;
            ui.infoBar.style.color = newColor;
            ui.svgLogo.style.fill = newColor;
        },
        infoBarBgColor() {
            ui.infoBar.style.backgroundColor = ui.infoBarBgColor.value;
        },
        position() {
            const bottom = ui.marginBottom.value;
            const x = ui.marginX.value;
            ui.infoBarContainer.style.bottom = `${bottom}px`;
            ui.infoBarContainer.style.left = `${x}px`;
            ui.infoBarContainer.style.right = `${x}px`;
            ui.marginBottomValue.textContent = bottom;
            ui.marginXValue.textContent = x;
            updateAllDynamicLabels();
        },
        imageTransform() {
            ui.previewImage.style.transform = `translate(${imageState.translateX}px, ${imageState.translateY}px) scale(${imageState.scale})`;
        },
        sizes() {
            const paddingY = ui.infoBarPaddingY.value;
            ui.infoBar.style.paddingTop = `${paddingY}px`;
            ui.infoBar.style.paddingBottom = `${paddingY}px`;
            ui.infoBarPaddingYValue.textContent = paddingY;

            ui.logoContainer.style.height = `${ui.logoSize.value}px`;
            ui.logoSizeValue.textContent = ui.logoSize.value;

            ui.groupNameImage.style.height = `${ui.groupNameSize.value}px`;
            ui.groupNameSizeValue.textContent = ui.groupNameSize.value;

            ui.previewTheme.style.fontSize = `${ui.themeSize.value}px`;
            ui.themeSizeValue.textContent = ui.themeSize.value;

            ui.previewThemeLine2.style.fontSize = `${ui.themeLine2Size.value}px`;
            ui.themeLine2SizeValue.textContent = ui.themeLine2Size.value;

            ui.previewName.style.fontSize = `${ui.memberNameSize.value}px`;
            ui.memberNameSizeValue.textContent = ui.memberNameSize.value;

            ui.previewRomaji.style.fontSize = `${ui.romajiNameSize.value}px`;
            ui.romajiNameSizeValue.textContent = ui.romajiNameSize.value;
            updateAllDynamicLabels();
        },
        elementPositions() {
            const logoX = ui.logoX.value;
            const logoY = ui.logoY.value;
            ui.logoBlock.style.left = `${logoX}px`;
            ui.logoBlock.style.transform = `translateY(calc(-50% + ${logoY}px))`;
            ui.logoXValue.textContent = logoX;
            ui.logoYValue.textContent = logoY;

            const groupNameX = ui.groupNameX.value;
            const groupNameY = ui.groupNameY.value;
            ui.groupNameBlock.style.left = `${groupNameX}px`;
            ui.groupNameBlock.style.transform = `translateY(calc(-50% + ${groupNameY}px))`;
            ui.groupNameXValue.textContent = groupNameX;
            ui.groupNameYValue.textContent = groupNameY;

            const themeX = ui.themeX.value;
            const themeY = ui.themeY.value;
            ui.themeBlock.style.transform = `translate(calc(-50% + ${themeX}px), calc(-50% + ${themeY}px))`;
            ui.themeXValue.textContent = themeX;
            ui.themeYValue.textContent = themeY;

            const themeLine2X = ui.themeLine2X.value;
            const themeLine2Y = ui.themeLine2Y.value;
            ui.themeLine2Block.style.transform = `translate(calc(-50% + ${themeLine2X}px), calc(-50% + ${themeLine2Y}px))`;
            ui.themeLine2XValue.textContent = themeLine2X;
            ui.themeLine2YValue.textContent = themeLine2Y;

            const nameX = ui.nameX.value;
            const nameY = ui.nameY.value;
            ui.nameBlock.style.right = `${-nameX}px`;
            ui.nameBlock.style.transform = `translateY(calc(-50% + ${nameY}px))`;
            ui.nameXValue.textContent = nameX;
            ui.nameYValue.textContent = nameY;

            const romajiX = ui.romajiX.value;
            const romajiY = ui.romajiY.value;
            ui.romajiBlock.style.right = `${-romajiX}px`;
            ui.romajiBlock.style.transform = `translateY(calc(-50% + ${romajiY}px))`;
            ui.romajiXValue.textContent = romajiX;
            ui.romajiYValue.textContent = romajiY;
            updateAllDynamicLabels();
        },
        fontFamily() {
            ui.previewTheme.style.fontFamily = ui.themeFontFamily.value;
            ui.previewThemeLine2.style.fontFamily = ui.themeFontFamily.value;
            ui.previewName.style.fontFamily = ui.nameFontFamily.value;
            ui.previewRomaji.style.fontFamily = ui.nameFontFamily.value;
        },
        updateLetterSpacing() {
            const themeLetterSpacing = ui.themeLetterSpacing.value;
            ui.previewTheme.style.letterSpacing = `${themeLetterSpacing}px`;
            ui.previewThemeLine2.style.letterSpacing = `${themeLetterSpacing}px`;
            ui.themeLetterSpacingValue.textContent = themeLetterSpacing;

            const memberNameLetterSpacing = ui.memberNameLetterSpacing.value;
            ui.previewName.style.letterSpacing = `${memberNameLetterSpacing}px`;
            ui.memberNameLetterSpacingValue.textContent = memberNameLetterSpacing;

            const romajiNameLetterSpacing = ui.romajiNameLetterSpacing.value;
            ui.previewRomaji.style.letterSpacing = `${romajiNameLetterSpacing}px`;
            ui.romajiNameLetterSpacingValue.textContent = romajiNameLetterSpacing;

            updateAllDynamicLabels();
        },
        groupTheme() {
            const groupName = ui.groupNameSelect.value;
            const preset = colorPresets[groupName];
            if (preset) {
                ui.infoBarBgColor.value = preset.bg;
                ui.infoColor.value = preset.text;
                ui.borderColor.value = preset.border;
                ui.body.style.backgroundColor = preset.bodyBg;
                ui.mainTitle.style.color = preset.titleColor;

                update.infoBarBgColor();
                update.infoColor();
                update.infoBarBorder();
            }

            const logoSrc = groupLogos[groupName];
            if (logoSrc) {
                ui.imageLogo.src = logoSrc;
                ui.imageLogo.style.display = 'block';
                ui.svgLogo.classList.add('hidden');
            }

            const groupNameImgSrc = groupNameImages[groupName];
            if (groupNameImgSrc) {
                ui.groupNameImage.src = groupNameImgSrc;
            }

            if (groupName === '日向坂46') {
                ui.groupNameSize.value = 12;
            } else {
                ui.groupNameSize.value = 14;
            }
            update.sizes();
        }
    };

    // --- Event Handlers ---
    const handleRomajiToggle = () => {
        if (ui.romajiToggle.checked) {
            ui.romajiBlock.classList.remove('hidden');
            ui.nameY.value = -7;
            ui.romajiY.value = 14;
        } else {
            ui.romajiBlock.classList.add('hidden');
            ui.nameY.value = 0;
        }
        update.elementPositions();
    };

    const handleThemeLine2Toggle = () => {
        if (ui.themeLine2Toggle.checked) {
            ui.themeLine2Block.classList.remove('hidden');
            ui.themeY.value = -4;
        } else {
            ui.themeLine2Block.classList.add('hidden');
            ui.themeY.value = 0;
        }
        update.elementPositions();
    };

    const handleWeightSelection = (e) => {
        const button = e.target.closest('.weight-btn');
        if (!button) return;

        const newWeight = button.dataset.weight;
        const controlsId = button.parentElement.id;

        // Remove active class from siblings and add to clicked button
        button.parentElement.querySelectorAll('.weight-btn').forEach(sib => sib.classList.remove('active-weight'));
        button.classList.add('active-weight');

        // Apply font weight to the correct preview element
        if (controlsId === 'theme-weight-controls') {
            ui.previewTheme.style.fontWeight = newWeight;
            ui.previewThemeLine2.style.fontWeight = newWeight;
        } else if (controlsId === 'member-name-weight-controls') {
            ui.previewName.style.fontWeight = newWeight;
        } else if (controlsId === 'romaji-name-weight-controls') {
            ui.previewRomaji.style.fontWeight = newWeight;
        }
    };

    const handleFontFamilyChange = (e) => {
        update.fontFamily();
        const selectEl = e.target;
        const newFontFamily = selectEl.value;
        const isMplus = newFontFamily.includes('mplus1p');
        const weightToSet = isMplus ? '300' : '400';

        let targetControls;
        if (selectEl.id === 'theme-font-family') {
            targetControls = ['theme-weight-controls'];
        } else if (selectEl.id === 'name-font-family') {
            targetControls = ['member-name-weight-controls', 'romaji-name-weight-controls'];
        }

        if (targetControls) {
            targetControls.forEach(controlsId => {
                const buttonToClick = document.querySelector(`#${controlsId} .weight-btn[data-weight='${weightToSet}']`);
                if (buttonToClick) {
                    buttonToClick.click();
                }
            });
        }
    };

    const handleFontUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const fontName = file.name.replace(/\.(ttf|otf|woff|woff2)$/, '');
        ui.fontUploadStatus.textContent = translations[currentLang].fontLoading.replace('{fontName}', fontName);

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const fontBuffer = e.target.result;
                const fontFace = new FontFace(fontName, fontBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);

                addCustomFontToSelectors(fontName);
                update.fontStyles();

                ui.fontUploadStatus.textContent = translations[currentLang].fontLoaded.replace('{fontName}', fontName);
                setTimeout(() => ui.fontUploadStatus.textContent = '', 3000);

            } catch (err) {
                console.error('Font loading failed:', err);
                ui.fontUploadStatus.textContent = translations[currentLang].fontError;
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    };

    const addCustomFontToSelectors = (fontName) => {
        const selectors = [ui.themeFontFamily, ui.nameFontFamily];
        selectors.forEach(select => {
            if ([...select.options].some(opt => opt.value === `"${fontName}"`)) return;

            const option = document.createElement('option');
            option.value = `"${fontName}"`;
            option.textContent = fontName + translations[currentLang].customFontSuffix;
            option.setAttribute('data-translate-custom-font', fontName);
            select.appendChild(option);
            select.value = `"${fontName}"`;
        });
    };

    const setupListeners = () => {
        ui.languageSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));

        ui.imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    ui.imageToCrop.src = event.target.result;
                    ui.cropModal.classList.remove('hidden');
                    ui.cropModal.classList.add('flex');

                    if (cropper) cropper.destroy();

                    cropper = new Cropper(ui.imageToCrop, {
                        aspectRatio: 89 / 127, viewMode: 1, dragMode: 'move', background: false, autoCropArea: 1,
                    });
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });

        ui.logoUpload.addEventListener('change', (e) => handleFileUpload(e, (result) => {
            ui.imageLogo.src = result;
            ui.imageLogo.style.display = 'block';
            ui.svgLogo.classList.add('hidden');
        }));

        ui.fontUpload.addEventListener('change', handleFontUpload);

        const addInputListener = (element, handler) => element.addEventListener('input', handler);
        const addChangeListener = (element, handler) => element.addEventListener('change', handler);

        addInputListener(ui.borderToggle, update.infoBarBorder);
        addInputListener(ui.borderColor, update.infoBarBorder);
        addInputListener(ui.borderThickness, update.infoBarBorder);
        addInputListener(ui.infoColor, update.infoColor);
        addInputListener(ui.infoBarBgColor, update.infoBarBgColor);
        addInputListener(ui.marginBottom, update.position);
        addInputListener(ui.marginX, update.position);

        [ui.infoBarPaddingY, ui.logoSize, ui.groupNameSize, ui.themeSize, ui.themeLine2Size, ui.memberNameSize, ui.romajiNameSize].forEach(el => addInputListener(el, update.sizes));
        [ui.logoX, ui.logoY, ui.groupNameX, ui.groupNameY, ui.themeX, ui.themeY, ui.themeLine2X, ui.themeLine2Y, ui.nameX, ui.nameY, ui.romajiX, ui.romajiY].forEach(el => addInputListener(el, update.elementPositions));

        [ui.themeFontFamily, ui.nameFontFamily].forEach(el => addChangeListener(el, handleFontFamilyChange));
        [ui.themeLetterSpacing, ui.memberNameLetterSpacing, ui.romajiNameLetterSpacing].forEach(el => addInputListener(el, update.updateLetterSpacing));

        addInputListener(ui.memberName, (e) => ui.previewName.textContent = e.target.value);
        addInputListener(ui.romajiName, (e) => ui.previewRomaji.textContent = e.target.value);
        addInputListener(ui.photoTheme, (e) => ui.previewTheme.textContent = e.target.value);
        addChangeListener(ui.groupNameSelect, update.groupTheme);

        addChangeListener(ui.romajiToggle, handleRomajiToggle);
        addChangeListener(ui.themeLine2Toggle, handleThemeLine2Toggle);

        document.getElementById('theme-weight-controls').addEventListener('click', handleWeightSelection);
        document.getElementById('member-name-weight-controls').addEventListener('click', handleWeightSelection);
        document.getElementById('romaji-name-weight-controls').addEventListener('click', handleWeightSelection);

        document.querySelectorAll('.swatch-container button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.currentTarget.parentElement.dataset.target;
                const color = e.currentTarget.dataset.color;
                const colorInput = document.getElementById(targetId);
                if (colorInput) {
                    colorInput.value = color;
                    colorInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        });

        ui.resetInfoBarBtn.addEventListener('click', resetInfoBarSettings);
        ui.imageContainer.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);

        ui.cropBtn.addEventListener('click', () => {
            if (cropper) {
                ui.previewImage.src = cropper.getCroppedCanvas().toDataURL('image/png');
                ui.previewImage.classList.remove('hidden');
                if (ui.placeholderContent) {
                    ui.placeholderContent.classList.add('hidden');
                }
                resetImageTransform();
                cropper.destroy();
                cropper = null;
                ui.cropModal.classList.add('hidden');
                ui.cropModal.classList.remove('flex');
            }
        });
        ui.cancelCropBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            ui.cropModal.classList.add('hidden');
            ui.cropModal.classList.remove('flex');
        });

        document.addEventListener('keydown', (e) => {
            if (!ui.cropModal.classList.contains('hidden')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ui.cropBtn.click();
                } else if (e.key === 'Escape') {
                    ui.cancelCropBtn.click();
                }
            }
        });

        ui.downloadBtn.addEventListener('click', handleDownload);
        ui.closeModalBtn.addEventListener('click', () => ui.errorModal.classList.add('hidden'));
        ui.closeSaveModalBtn.addEventListener('click', () => {
            ui.saveModal.classList.add('hidden');
            ui.saveModal.classList.remove('flex');
        });

        document.getElementById('theme-weight-controls').addEventListener('click', handleWeightSelection);
        document.getElementById('member-name-weight-controls').addEventListener('click', handleWeightSelection);
        document.getElementById('romaji-name-weight-controls').addEventListener('click', handleWeightSelection);
    };

    const handleFileUpload = (event, callback) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => callback(e.target.result);
            reader.readAsDataURL(file);
        }
    };

    const resetInfoBarSettings = () => {
        const controls = ui.controlPanel.querySelectorAll(
            'input[type="range"], input[type="color"], select, input[type="checkbox"]'
        );

        controls.forEach(control => {
            if (control.type === 'file' || control.id === 'group-name-select') {
                return;
            }

            if (control.type === 'checkbox') {
                control.checked = control.defaultChecked;
            } else if (control.tagName === 'SELECT') {
                const defaultOption = control.querySelector('option[selected]');
                if (defaultOption) {
                    control.value = defaultOption.value;
                } else if (control.options.length > 0) {
                    control.selectedIndex = 0;
                }
            } else {
                control.value = control.defaultValue;
            }
        });

        Object.values(update).forEach(func => func());

        handleRomajiToggle();
        handleThemeLine2Toggle();
    };

    const resetImageTransform = () => {
        imageState = { scale: 1, translateX: 0, translateY: 0 };
        update.imageTransform();
    };

    const startDrag = (e) => {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX - imageState.translateX;
        startY = e.clientY - imageState.translateY;
        ui.imageContainer.style.cursor = 'grabbing';
    };

    const drag = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        imageState.translateX = e.clientX - startX;
        imageState.translateY = e.clientY - startY;
        update.imageTransform();
    };

    const stopDrag = () => {
        isDragging = false;
        ui.imageContainer.style.cursor = 'grab';
    };

    const handleDownload = async () => {
        ui.loadingText.classList.remove('hidden');
        ui.downloadBtn.disabled = true;
        ui.downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            await document.fonts.ready;

            const scaleFactor = 3;
            const rect = ui.photoCard.getBoundingClientRect();
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = rect.width * scaleFactor;
            finalCanvas.height = rect.height * scaleFactor;
            const ctx = finalCanvas.getContext('2d');
            ctx.scale(scaleFactor, scaleFactor);

            // 1. Draw main image
            const img = ui.previewImage;
            if (img.src && img.complete && img.naturalWidth > 0) {
                const containerRect = ui.imageContainer.getBoundingClientRect();
                const photoCardRect = ui.photoCard.getBoundingClientRect();
                const containerX = containerRect.left - photoCardRect.left;
                const containerY = containerRect.top - photoCardRect.top;
                ctx.save();
                ctx.beginPath();
                ctx.rect(containerX, containerY, containerRect.width, containerRect.height);
                ctx.clip();

                const transformedWidth = containerRect.width * imageState.scale;
                const transformedHeight = containerRect.height * imageState.scale;
                const drawX = containerX + imageState.translateX + (containerRect.width - transformedWidth) / 2;
                const drawY = containerY + imageState.translateY + (containerRect.height - transformedHeight) / 2;

                ctx.drawImage(img, drawX, drawY, transformedWidth, transformedHeight);
                ctx.restore();
            }

            // 2. Draw info bar background and border
            const photoCardRect = ui.photoCard.getBoundingClientRect();
            const infoBarRect = ui.infoBar.getBoundingClientRect();
            const infoBarX = infoBarRect.left - photoCardRect.left;
            const infoBarY = infoBarRect.top - photoCardRect.top;
            const infoBarWidth = infoBarRect.width;
            const infoBarHeight = infoBarRect.height;

            ctx.fillStyle = ui.infoBarBgColor.value;
            ctx.fillRect(infoBarX, infoBarY, infoBarWidth, infoBarHeight);

            if (ui.borderToggle.checked) {
                ctx.strokeStyle = ui.borderColor.value;
                ctx.lineWidth = parseFloat(ui.borderThickness.value);
                ctx.strokeRect(infoBarX, infoBarY, infoBarWidth, infoBarHeight);
            }

            // 3. Draw all elements inside the info bar
            const elementsToDraw = [
                { el: ui.logoContainer, isLogo: true },
                { el: ui.groupNameImage, isImage: true },
                { el: ui.previewTheme },
                { el: ui.previewThemeLine2 },
                { el: ui.previewName },
                { el: ui.previewRomaji },
            ];

            for (const item of elementsToDraw) {
                if ((item.el === ui.previewRomaji && ui.romajiBlock.classList.contains('hidden')) ||
                    (item.el === ui.previewThemeLine2 && ui.themeLine2Block.classList.contains('hidden'))) {
                    continue;
                }
                if (!item.el) continue;

                const elRect = item.el.getBoundingClientRect();
                const x = elRect.left - infoBarRect.left;
                const y = elRect.top - infoBarRect.top;

                const drawX = infoBarX + x;
                const drawY = infoBarY + y;

                if (item.isLogo || item.isImage) {
                    const targetImg = item.isLogo ? (ui.imageLogo.src && !ui.imageLogo.classList.contains('hidden') && ui.imageLogo.complete ? ui.imageLogo : ui.svgLogo) : item.el;

                    if (targetImg.tagName === 'IMG') {
                        if (targetImg.complete) {
                            ctx.drawImage(targetImg, drawX, drawY, elRect.width, elRect.height);
                        }
                    } else { // SVG Logic
                        const svgText = new XMLSerializer().serializeToString(targetImg);
                        const coloredSvgText = svgText.replace(/class="fill-current"/g, `fill="${ui.infoColor.value}"`);
                        const svgBlob = new Blob([coloredSvgText], { type: 'image/svg+xml;charset=utf-8' });
                        const url = URL.createObjectURL(svgBlob);
                        const svgImage = await new Promise(resolve => {
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.onerror = () => resolve(null);
                            img.src = url;
                        });
                        if (svgImage) {
                            ctx.drawImage(svgImage, drawX, drawY, elRect.width, elRect.height);
                        }
                        URL.revokeObjectURL(url);
                    }
                } else {
                    const computedStyle = getComputedStyle(item.el);
                    ctx.fillStyle = computedStyle.color;
                    ctx.font = `${computedStyle.fontWeight} ${computedStyle.fontSize} ${computedStyle.fontFamily}`;
                    ctx.letterSpacing = computedStyle.letterSpacing;
                    ctx.textAlign = computedStyle.textAlign;
                    ctx.textBaseline = 'middle';

                    let textX = drawX;
                    if (ctx.textAlign === 'right') {
                        textX = drawX + elRect.width;
                    } else if (ctx.textAlign === 'center') {
                        textX = drawX + elRect.width / 2;
                    }
                    const textY = drawY + elRect.height / 2;
                    ctx.fillText(item.el.textContent, textX, textY);
                }
            }

            // 4. Trigger download
            const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);

            if (isMobile) {
                ui.finalImage.src = finalCanvas.toDataURL('image/png');
                ui.saveModal.classList.remove('hidden');
                ui.saveModal.classList.add('flex');
            } else {
                const finalLink = document.createElement('a');
                const memberName = ui.memberName.value.trim() || 'member';
                const theme = ui.photoTheme.value.trim() || 'custom';
                finalLink.download = `photo_card_${memberName}_${theme.replace(/\s+/g, '_')}.png`;
                finalLink.href = finalCanvas.toDataURL('image/png');
                finalLink.click();
            }

        } catch (err) {
            console.error('图片生成失败:', err);
            ui.errorMessage.textContent = `${translations[currentLang].errorMessage} (提示: 如果在本地运行, 请使用Live Server等本地服务器, 不要直接打开file://路径。)`;
            ui.errorModal.classList.remove('hidden');
        } finally {
            ui.loadingText.classList.add('hidden');
            ui.downloadBtn.disabled = false;
            ui.downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    };

    const init = () => {
        setupListeners();

        const allControls = document.querySelectorAll('#control-panel input, #control-panel select, #control-panel textarea');
        allControls.forEach(control => {
            if (control.type === 'file') return;
            // Dispatch both events to ensure all updates are triggered
            ['input', 'change'].forEach(eventType => {
                control.dispatchEvent(new Event(eventType, { bubbles: true }));
            });
        });

        // Initial setup calls
        update.groupTheme();
        update.fontFamily();

        // Set initial weights correctly by simulating clicks
        const initialThemeFont = ui.themeFontFamily.value;
        const initialThemeWeight = initialThemeFont.includes('mplus1p') ? '300' : '400';
        document.querySelector(`#theme-weight-controls .weight-btn[data-weight="${initialThemeWeight}"]`).click();

        const initialNameFont = ui.nameFontFamily.value;
        const initialNameWeight = initialNameFont.includes('mplus1p') ? '300' : '400';
        document.querySelector(`#member-name-weight-controls .weight-btn[data-weight="${initialNameWeight}"]`).click();
        document.querySelector(`#romaji-name-weight-controls .weight-btn[data-weight="${initialNameWeight}"]`).click();

        // Set language
        const userLang = navigator.language || navigator.userLanguage;
        let initialLang = 'zh';
        if (userLang.startsWith('en')) {
            initialLang = 'en';
        } else if (userLang.startsWith('ja')) {
            initialLang = 'ja';
        }
        ui.languageSwitcher.value = initialLang;
        setLanguage(initialLang);
    };

    init();
});
